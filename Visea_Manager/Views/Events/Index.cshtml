@model Tuple<IEnumerable<Visea_Expense_Manager.Models.Event>, IEnumerable<Visea_Expense_Manager.Models.User>, Boolean, Visea_Expense_Manager.Data.MvcNoteContext>

@{
    ViewData["Title"] = "Evénements";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">

<style>
    .rcornerimport {
        border-radius: 25px;
        border: 2px solid #224BB6;
        padding: 1em;
        width: 300px;
        height: 130px;
        margin: 6px;
    }

    .rcornerfilter {
        border-radius: 25px;
        border: 2px solid #224BB6;
        padding: 1em;
        width: 100%;
        height: 100%;
        margin: 6px;
    }

    .flexintro {
        flex-wrap: wrap;
        margin: 6px
    }

    .zblock {
        margin-bottom: 50px;
        margin-top: 50px;
    }

    .dataTables_filter input {
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }

    .zbtn {
        margin: 6px;
    }

    div.dataTables_length {
        float: left;
    }

    div.dataTables_filter {
        float: right;
    }

    div.dataTables_info {
        float: left;
    }

    div.dataTables_paginate {
        float: right;
    }

    div.DTTT {
        float: left;
        margin-right: 50px;
    }

    div.buttons {
        clear: both;
    }


</style>
<h1>
    Liste de tous les événements
</h1>

<div class="flexintro">
    <div>
        <form class="rcornerfilter" method="post" enctype="multipart/form-data" asp-action="Index">
            <div style="display:flex;flex-wrap:wrap">
                <div style="margin:4px">
                    <div class="form-group">
                        <label class="control-label">Date de debut</label>
                        <input class="form-control" type="date" data-val="true" data-val-required="The Date field is required." value="" name="date_debut" />
                    </div>
                    <div class="form-group">
                        <label class="control-label">Date de fin</label>

                        <input class="form-control" type="date" data-val="true" data-val-required="The Date field is required." value="" name="date_fin" />
                    </div>
                    @if (Model.Item3)
                    {
                        <div class="form-group">
                            <label class="control-label">Choisir un consultant</label>
                            <select name="idstr" id="idstr" class="form-control">
                            </select>
                        </div>
                    }
                </div>
                <div style="margin:4px">
                    <div class="form-group">
                        <label class="control-label">Type d'événement</label>
                        <select name="Type_Id" id="Item1_Type_Id" class="form-control">
                        </select>
                    </div>

                    <div hidden id="client_formation" class="form-group">
                        <label hidden id="formationlabel" class="control-label">Type de la formation </label>
                        <label hidden id="clientlabel" class="control-label">Client </label>
                        <select name="Classe_Id" id="Item1_Classe_Id" class="form-control">
                        </select>
                    </div>
                </div>
                <div style="margin:4px">
                    <div hidden id="missionoutypeformation" class="form-group">
                        <label class="control-label">Mission</label>
                        <select name="Classe2_Id" id="Item1_Classe2_Id" class="form-control">
                        </select>
                    </div>
                    <div hidden id="type_mission" class="form-group">
                        <label class="control-label">Objet</label>
                        <select name="Classe3_Id" id="Item1_Classe3_Id" class="form-control">
                        </select>
                    </div>
                    <div hidden id="etape_mission" class="form-group">
                        <label class="control-label">Etape de la mission</label>
                        <select id="Item1_Classe4_Id" class="form-control">
                        </select>
                    </div>
                </div>
                    <div class="form-group" style="position:relative" >
                        <input type="submit" value="Filtrer" class="btn btn-primary" style="position:absolute;bottom:-1px;margin:6px" />
                    </div>
                </div>
</form>
    </div>
</div>
<!--
<form asp-action="Edit">1
    <div class="form-group">
        <label asp-for="Date" class="control-label"></label>
        <input asp-for="Date" class="form-control" />
        <span asp-validation-for="Date" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="Date_of_creation" class="control-label"></label>
        <input asp-for="Date_of_creation" class="form-control" />
        <span asp-validation-for="Date_of_creation" class="text-danger"></span>
    </div>
    <div class="form-group">
        <input type="submit" value="Save" class="btn btn-primary" />
    </div>
</form>
-->
<div style="margin: 18px; margin-bottom: 42px;overflow-x: auto">
    <table id="listeday" class="table table-striped table-bordered" style="width:100%;font-size:13px" >
        <thead>
            <tr>

                <th>
                    @Html.DisplayNameFor(model => model.Item1.FirstOrDefault().Date)
                </th>
                <th> Mois </th>
                <th>
                    @Html.DisplayNameFor(model => model.Item1.FirstOrDefault().Type)
                </th>
                <th>
                    Client
                </th>
                <th>
                    Mission
                </th>
                <th>
                    Objet
                </th>
                <th>
                    Etape
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Item1.FirstOrDefault().Heures)
                </th>
                <th>
                    Nature
                </th>
                <th>
                    Commentaire
                </th>
                @if (Model.Item3)
                {
                    <th>
                        Utilisateur
                    </th>
                }
                
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Item1)
            {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.Date)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Date.Month)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Type)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Classe_str)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Classe2_str)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Classe3_str)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Classe4_str)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => new TimeSpan(item.Heures.Hour, item.Heures.Minute, 0).TotalHours)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Nature)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.commente)
                </td>
                @if (Model.Item3)
                {
                    <td>
                        @item.User.Remove(item.User.Length - 20, 20)
                    </td>
                }
            </tr>
            }
        </tbody>
    </table>
</div>
@if (Model.Item3)
{
    <script>
        var json;
        json = '@Json.Serialize(Model.Item2.OrderBy(user => user.Name))';

        var list = JSON.parse(json);

        console.log(list);
        m = "<option value=null>--Please choose an option--</option>";
        for (i = 0; i < list.length; i += 1) {
            m +=  '<option value=' + list[i].id + '>' + list[i].name + '</option>';
        }
        document.getElementById('idstr').innerHTML = m;
        //document.getElementById('User_selection').hidden = false;
    </script>

}
<div class="zblock" style="margin:100px"></div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="~/js/jquery.dataTables.min.js" defer></script>
<script src="~/js/dataTables.bootstrap4.min.js" defer></script>


<script src="~/js/dataTables.buttons.min.js" defer></script>
<script src="~/js/buttons.flash.min.js" defer></script>
<script src="~/js/jszip.min.js" defer></script>
<script src="~/js/buttons.html5.min.js" defer></script>
<script src="~/js/buttons.print.min.js" defer></script>
<script src="~/js/moment.min.js" defer></script>
<script src="~/js/datetime-moment.js" defer></script>
<script>
    $(document).ready(function () {
        $.fn.dataTable.moment('DD/MM/YYYY');
        var table = $('#listeday').DataTable({
            responsive: true,
            select: true,
            dom: 'lftipB',
            buttons: [
                {
                    extend: 'copyHtml5',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6, 7, 8,9,10]
                    }
                },
                {
                    extend: 'excelHtml5',
                    autoFilter: true,
                    title: '',
                    sheetName: 'Exported data',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6, 7, 8,9,10]
                    }
                },
                {
                    extend: 'print',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6, 7, 8,9,10]
                    }
                }
            ],
            initComplete: function () {
                var btns = $('.dt-button');
                btns.addClass('btn btn-primary zbtn');
            },
            "columnDefs": [
                { "visible": false, "targets": 1 },
            ]
        });
    });
    $(function () {
        json = '@Json.Serialize(Model.Item4.TypeEvent.OrderBy(user => user.Name))';
        var list = JSON.parse(json);
        m = "<option value=\"\">--Please choose an option--</option>";
        for (i = 0; i < list.length; i += 1) {
            m +=  '<option value=' + list[i].name + '>' + list[i].name + '</option>';
        }
        document.getElementById('Item1_Type_Id').innerHTML = m;
    });
    $('#Item1_Type_Id').on("change", function (e) {
        //if ($(this).val() == 1 || $(this).val() == 2) {
        if ($(this).val() == "Clientèle" || $(this).val() == "Formation") {
            var json;
            if ($(this).val() == "Clientèle" ) {
                json = '@Json.Serialize(Model.Item4.Client.OrderBy(user => user.Name))';
                document.getElementById('clientlabel').hidden = false;
                document.getElementById('formationlabel').hidden = true;
            }
            else {
                json = '@Json.Serialize(Model.Item4.Formation.OrderBy(user => user.Name))';
                document.getElementById('clientlabel').hidden = true;
                document.getElementById('formationlabel').hidden = false;
            }
            var list = JSON.parse(json);

            console.log(list);
            m = "<option value=0>--Please choose an option--</option>";
            for (i = 0; i < list.length; i += 1) {
                m +=  '<option value=' + list[i].id + '>' + list[i].name + '</option>';
            }
            document.getElementById('Item1_Classe_Id').innerHTML = m;
            document.getElementById('client_formation').hidden = false;
            hidden_Groupe_Classe(2);
        }
        else {
            hidden_Groupe_Classe(1);
        }
    });
    $('#Item1_Classe_Id').on("change", function (e) {
        if (($('#Item1_Type_Id').val() == "Clientèle") && $(this).val() > 0) {
            var json;

            json = '@Json.Serialize(Model.Item4.Mission.OrderBy(user => user.Name))';
            

            var list = JSON.parse(json);
            console.log(list);
            m = "<option value=0>--Please choose an option--</option>";
            for (i = 0; i < list.length; i += 1) {
                if ($('#Item1_Type_Id').val() == "Clientèle" && $('#Item1_Classe_Id').val() != list[i].client_Id)
                    continue;
                m +=  '<option value=' + list[i].id + '>' + list[i].name + '</option>';
            }
            document.getElementById('Item1_Classe2_Id').innerHTML = m;
            document.getElementById('missionoutypeformation').hidden = false;
            hidden_Groupe_Classe(3);
        }
        else {
            hidden_Groupe_Classe(2);
        }

    });
    $('#Item1_Classe2_Id').on("change", function (e) {
        if ($('#Item1_Type_Id').val() == "Clientèle"  && $(this).val() > 0) {
            var json = '@Json.Serialize(Model.Item4.Type_Mission.OrderBy(user => user.Name))';
            var list = JSON.parse(json);
            console.log(list);
            m = "<option value=0>--Please choose an option--</option>";
            for (i = 0; i < list.length; i += 1) {
                if ($('#Item1_Classe2_Id').val() != list[i].mission_Id)
                    continue;
                m += '<option value=' + list[i].id + '>' + list[i].name + '</option>';
            }
            document.getElementById('Item1_Classe3_Id').innerHTML = m;
            document.getElementById('type_mission').hidden = false;
            hidden_Groupe_Classe(4);
        }
        else {
            hidden_Groupe_Classe(3);
        }

    });
    $('#Item1_Classe3_Id').on("change", function (e) {
        hidden_Groupe_Classe(4);
        if ($('#Item1_Type_Id').val() == "Clientèle"  && $(this).val() > 0 ) {
            var json = '@Json.Serialize(Model.Item4.Etape_Mission.OrderBy(user => user.Name))';
            var list = JSON.parse(json);
            console.log(list);
            m = "<option value=0>--Please choose an option--</option>";
            for (i = 0; i < list.length; i += 1) {
                if ($('#Item1_Classe3_Id').val() != list[i].type_Mission_Id)
                    continue;
                m +=  '<option value=' + list[i].id + '>' + list[i].name + '</option>';
            }
            document.getElementById('Item1_Classe4_Id').innerHTML = m;
            document.getElementById('etape_mission').hidden = false;
        }
        else {
            hidden_Groupe_Classe(4);
        }

    });

    function hidden_Groupe_Classe(type) {
        switch (type) {
            case 1:
                $('#Item1_Classe_Id').val(0);
                document.getElementById('Item1_Classe_Id').innerHTML = "";
                document.getElementById('client_formation').hidden = true;
                document.getElementById('clientlabel').hidden = true;
                document.getElementById('formationlabel').hidden = true;
            case 2:
                $('#Item1_Classe2_Id').val(0);
                document.getElementById('Item1_Classe2_Id').innerHTML = "";
                document.getElementById('missionoutypeformation').hidden = true;
            case 3:
                $('#Item1_Classe3_Id').val(0);
                document.getElementById('Item1_Classe3_Id').innerHTML = "";
                document.getElementById('type_mission').hidden = true;
            case 4:
                $('#Item1_Classe4_Id').val(0);
                document.getElementById('Item1_Classe4_Id').innerHTML = "";
                document.getElementById('etape_mission').hidden = true;
        }
    }
</script>